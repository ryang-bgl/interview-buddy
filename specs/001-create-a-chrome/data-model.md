# Data Model – Save LeetCode Problems from Chrome Extension

## Entity: LeetCodeProblemCapture
- **Table**: `leetcode_capture`
- **Primary Key**: `id` (UUID v7 generated by backend)
- **Fields**:
  - `user_id` (UUID, not null) – owner of the capture; FK to `ib_user.id`
  - `problem_slug` (varchar 255, not null) – normalized identifier parsed from canonical URL
  - `problem_title` (varchar 255, not null)
  - `problem_url` (varchar 512, not null)
  - `difficulty` (enum: `EASY`, `MEDIUM`, `HARD`, `UNKNOWN`, not null)
  - `tags` (json, nullable) – array of strings when provided
  - `statement_markdown` (text, not null) – full problem statement; "unknown" placeholder when scraped data missing
  - `solution_language` (enum: `JAVA`, `PYTHON`, `CPP`, `JAVASCRIPT`, `TYPESCRIPT`, `GO`, `RUST`, `RUBY`, `SWIFT`, `KOTLIN`, `CSHARP`, `OTHER`, not null)
  - `solution_snippet` (mediumtext, not null) – user-provided code snapshot
  - `notes` (mediumtext, nullable)
  - `captured_at` (timestamp with time zone, not null, default `now()`)
  - `ingested_at` (timestamp with time zone, not null) – server receipt time
  - `payload_checksum` (char 64, not null) – SHA-256 over `user_id + problem_slug + solution_snippet`
  - `source_version` (varchar 32, not null) – extension version that produced the capture

- **Derived/Computed**:
  - UNIQUE constraint on `(user_id, problem_slug)` to enforce FR-009.
  - Index on `captured_at` for retrieval ordering.

- **Validation**:
  - `problem_url` must begin with `https://leetcode.com/`.
  - `solution_snippet` size ≤ 1 MB; enforced via backend validation before persistence.
  - `statement_markdown`, `solution_snippet`, `notes` normalized to LF newlines.

## Value Object: CaptureSubmissionRequest
- **Purpose**: DTO representing payload sent from extension to backend.
- **Fields**:
  - `apiKey` (string, required, 32–128 chars)
  - `problem`: object with `title`, `slug`, `url`, `difficulty`, `tags`, `statement`, `capturedAt` (ISO 8601 string or `null`)
  - `solution`: object with `language` (enum above), `snippet`
  - `notes` (string | null)
  - `clientMetadata`: object with `extensionVersion`, `chromeVersion`, `os`

- **Validation**:
  - Reject if `problem.url` missing or invalid URL format.
  - Translate missing fields to string "unknown" before persistence to honor FR-002.

## Value Object: CaptureSubmissionResponse
- **Purpose**: API response to extension.
- **Fields**:
  - `captureId` (UUID)
  - `status` (`"saved"` | `"duplicate"` | `"error"`)
  - `message` (string)
  - `reauthenticate` (boolean, default false) – instructs extension to show reauth button when backend rejects API key.
  - `retryAfterSeconds` (integer | null) – provided for transient errors.

## Domain Service: CaptureDuplicatePolicy
- **Responsibility**: Determine whether the incoming capture collides with an existing record.
- **Rules**:
  - Check unique index on `(user_id, problem_slug)` first.
  - If checksum matches but metadata differs, respond with `"duplicate"` and include previously stored `captureId` in response message for reference (no new persistence).
  - Emits audit event `leetcode.capture.duplicate` for observability.

## Integration: API Key Authentication
- **Flow**:
  - API key resolves to `user_id` via existing credential table (not defined here but assumed present in backend).
  - Failed lookup returns 401 with `reauthenticate=true` in response payload and does not proceed to persistence.
  - Rate limit: 30 capture attempts per user per minute enforced by Spring bucket4j filter (existing infrastructure assumed available; reuse if present).

